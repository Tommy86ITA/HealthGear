@using HealthGear.Helpers
@model IEnumerable<Device>

@{
    ViewData["Title"] = "Elenco Dispositivi";
}

<h2 class="mb-4">Elenco Dispositivi</h2>

<a asp-action="Create" class="btn btn-success mb-3">
    <i class="fas fa-plus"></i> Aggiungi Dispositivo
</a>

<table class="table table-striped table-bordered text-center">
    <thead class="thead-dark">
    <tr>
        <th>Nome</th>
        <th>Produttore</th>
        <th>Modello</th>
        <th>Numero di Serie</th>
        <th class="text-center">ðŸ›  Manutenzione</th>
        <th class="text-center">âš¡ Verifica Elettrica</th>
        <th class="text-center">ðŸ“‹ Controllo Fisico</th>
        <th class="text-center">Azioni</th>
    </tr>
    </thead>
    <tbody>
    @foreach (var device in Model)
    {
        <tr id="device-row-@device.Id"> <!-- ID per riferimento JS -->
            <td>@device.Name</td>
            <td>@device.Brand</td>
            <td>@device.Model</td>
            <td>@device.SerialNumber</td>

            <td>
                <span class="@(DueDateHelper.GetDueDateClass(device.NextMaintenanceDue))">
                    @(device.NextMaintenanceDue?.ToShortDateString() ?? "N/A")
                </span>
            </td>

            <td>
                <span class="@(DueDateHelper.GetDueDateClass(device.NextElectricalTestDue))">
                    @(device.NextElectricalTestDue?.ToShortDateString() ?? "N/A")
                </span>
            </td>

            <td>
                <span class="@(DueDateHelper.GetDueDateClass(device.NextPhysicalInspectionDue))">
                    @(device.NextPhysicalInspectionDue?.ToShortDateString() ?? "N/A")
                </span>
            </td>

            <td>
                <a asp-action="Details" asp-route-id="@device.Id" class="btn btn-info btn-sm" data-toggle="tooltip"
                   title="Dettagli">
                    <i class="fas fa-eye"></i>
                </a>
                <a asp-action="Edit" asp-route-id="@device.Id" class="btn btn-warning btn-sm" data-toggle="tooltip"
                   title="Modifica">
                    <i class="fas fa-edit"></i>
                </a>

                @if (device.Interventions.Any())
                {
                    <!-- Se il dispositivo ha interventi, puÃ² solo essere archiviato -->
                    <button class="btn btn-secondary btn-sm" disabled
                            title="Il dispositivo ha interventi registrati e non puÃ² essere eliminato">
                        <i class="fas fa-trash"></i>
                    </button>
                    <a asp-action="Archive" asp-route-id="@device.Id" class="btn btn-dark btn-sm" data-toggle="tooltip"
                       title="Archivia (Dismesso)">
                        <i class="fas fa-archive"></i>
                    </a>
                }
                else
                {
                    <!-- Se il dispositivo non ha interventi, puÃ² essere eliminato -->
                    <button class="btn btn-danger btn-sm delete-btn" data-id="@device.Id" data-name="@device.Name"
                            title="Elimina">
                        <i class="fas fa-trash"></i>
                    </button>
                }
            </td>
        </tr>
    }
    </tbody>
</table>

<!-- Modale conferma eliminazione -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Conferma Eliminazione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
            </div>
            <div class="modal-body">
                <p>Sei sicuro di voler eliminare il dispositivo <strong id="deleteDeviceName"></strong>? Questa azione
                    non puÃ² essere annullata.</p>
                <form id="deleteForm" method="post">
                    <input type="hidden" id="deleteDeviceId" name="id"/>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="submit" class="btn btn-danger" id="confirmDeleteBtn">Elimina</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const deleteConfirmModal = new bootstrap.Modal(document.getElementById("deleteConfirmModal"));
        const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");

        document.querySelectorAll(".delete-btn").forEach(button => {
            button.addEventListener("click", function () {
                let deviceId = this.getAttribute("data-id");
                let deviceName = this.getAttribute("data-name");

                document.getElementById("deleteDeviceId").value = deviceId;
                document.getElementById("deleteDeviceName").innerText = deviceName;

                deleteConfirmModal.show();
            });
        });

        confirmDeleteBtn.addEventListener("click", function () {
            let deviceId = document.getElementById("deleteDeviceId").value;
            let confirmName = document.getElementById("deleteDeviceName").innerText;

            console.log("Invio DELETE per il dispositivo ID:", deviceId, "Nome:", confirmName);

            fetch(`/Device/DeleteConfirmed/${deviceId}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ConfirmName: confirmName})
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.message || "Errore generico");
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Risposta server:", data);
                    if (data.success) {
                        document.getElementById(`device-row-${deviceId}`).remove(); // Rimuove la riga dalla tabella
                        deleteConfirmModal.hide();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error("Errore:", error);
                    alert("Errore durante l'eliminazione: " + error.message);
                });
        });
    });
</script>