@model Maintenance

<h2>Aggiungi Manutenzione</h2>

<form asp-action="Create" method="post" enctype="multipart/form-data">
    <input type="hidden" asp-for="DeviceId" value="@ViewBag.DeviceId"/>

    <div class="form-group">
        <label asp-for="MaintenanceDate" class="control-label">Data di Manutenzione</label>
        <input asp-for="MaintenanceDate"
               class="form-control"
               type="date"
               id="maintenanceDate"
               max="@DateTime.Today.ToString("yyyy-MM-dd")"
               required
               placeholder="Seleziona la data"/>
        <span asp-validation-for="MaintenanceDate" class="text-danger" id="dateErrorMessage"></span>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var dateInput = document.getElementById("maintenanceDate");
            var errorMessage = document.getElementById("dateErrorMessage");
            var today = new Date().toISOString().split('T')[0];  // Otteniamo la data odierna in formato YYYY-MM-DD
            dateInput.setAttribute("max", today);  // Impostiamo il limite massimo nel datepicker

            function validateDate() {
                var selectedDate = new Date(dateInput.value);
                var maxDate = new Date(today);

                if (!dateInput.value) {
                    errorMessage.textContent = "Il campo data è obbligatorio.";
                    dateInput.classList.add("is-invalid");
                    return false;
                }

                if (selectedDate > maxDate) {
                    errorMessage.textContent = "La data di manutenzione non può essere futura. Inserisci una data valida.";
                    dateInput.classList.add("is-invalid");
                    return false;
                } else {
                    errorMessage.textContent = "";
                    dateInput.classList.remove("is-invalid");
                    return true;
                }
            }

            dateInput.addEventListener("input", function () {
                validateDate();
            });

            document.querySelector("form").addEventListener("submit", function (e) {
                if (!validateDate()) {
                    e.preventDefault();
                }
            });
        });
    </script>

    <div class="form-group">
        <label asp-for="Description" class="control-label">Descrizione</label>
        <textarea asp-for="Description"
                  class="form-control"
                  placeholder="Inserisci una descrizione dettagliata"
                  rows="3"
                  required></textarea>
        <span asp-validation-for="Description" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="PerformedBy" class="control-label">Eseguito da</label>
        <input asp-for="PerformedBy"
               class="form-control"
               placeholder="Nome del tecnico"
               required
               maxlength="100"/>
        <span asp-validation-for="PerformedBy" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="MaintenanceType" class="control-label">Tipo di Manutenzione</label>
        <select asp-for="MaintenanceType" class="form-control" required>
            <option value="">-- Seleziona il tipo di manutenzione --</option>
            <option value="Ordinaria">Ordinaria</option>
            <option value="Straordinaria">Straordinaria</option>
            <option value="Correttiva">Correttiva</option>
        </select>
        <span asp-validation-for="MaintenanceType" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label class="control-label">Allega Documenti (PDF, JPG, PNG, max 5MB)</label>
        <input type="file" id="fileInput" name="files" class="form-control" multiple accept=".pdf, .jpg, .png"/>
        <small class="form-text text-muted">Puoi caricare più file contemporaneamente.</small>
        <span id="fileErrorMessage" class="text-danger"></span>
    </div>

    <script>
        document.getElementById("fileInput").addEventListener("change", function () {
            var fileInput = document.getElementById("fileInput");
            var errorMessage = document.getElementById("fileErrorMessage");
            var allowedExtensions = /(\.pdf|\.jpg|\.png)$/i;
            var maxSizeInMB = 5;
            var isValid = true;

            for (let i = 0; i < fileInput.files.length; i++) {
                let file = fileInput.files[i];
                if (!allowedExtensions.exec(file.name)) {
                    errorMessage.textContent = "Formato file non valido. Carica solo PDF, JPG o PNG.";
                    fileInput.value = "";
                    isValid = false;
                }
                if (file.size > maxSizeInMB * 1024 * 1024) {
                    errorMessage.textContent = "Ogni file non deve superare i 5MB.";
                    fileInput.value = "";
                    isValid = false;
                }
            }

            if (isValid) {
                errorMessage.textContent = "";
            }
        });
    </script>

    <div class="form-group mt-3">
        <button type="submit" class="btn btn-primary">Salva</button>
        <a asp-action="Index" asp-route-deviceId="@ViewBag.DeviceId" class="btn btn-secondary">Annulla</a>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial"/>
}